{% extends "base.html" %}

{% block body %}
<style>
    .team-card {
        transition: transform 0.5s ease-in-out;
    }

    .switch-left {
        transform: translateX(180px);
    }

    .switch-right {
        transform: translateX(-180px);
    }

    .hidden {
        opacity: 0;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

<h1 class="text-4xl font-bold text-center mt-8">Match Scoreboard{{ match_data.team2_id }}</h1>

<div class="flex justify-center items-center mt-8">
    <div class="team-card p-6 border-2 rounded-lg shadow-lg bg-white text-center mr-8" id="teamA">
        <div class="team-name text-2xl font-semibold">{{match_data.team1.name}}</div>
        <div class="team-score text-6xl mt-4" id="scoreA">{{ match_data.current_set.team1_score }}</div>
    </div>

    <div class="controls flex flex-col items-center">
        <button id="startMatch"
            class="mb-4 py-2 px-6 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition">Start
            Match</button>
        <button id="switchTeams"
            class="py-2 px-6 bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600 transition">Switch
            Teams</button>
    </div>

    <div class="team-card p-6 border-2 rounded-lg shadow-lg bg-white text-center ml-8" id="teamB">
        <div class="team-name text-2xl font-semibold">{{match_data.team2.name}}</div>
        <div class="team-score text-6xl mt-4" id="scoreB">{{ match_data.current_set.team2_score }}</div>
    </div>
</div>

<div class="flex justify-center mt-8">
    <button onclick="increaseScore('A')"
        class="py-2 px-6 bg-green-600 text-white rounded-lg shadow-md mr-4 hover:bg-green-700 transition">+1 Team
        A</button>
    <button onclick="decreaseScore('A')"
        class="py-2 px-6 bg-red-600 text-white rounded-lg shadow-md mr-4 hover:bg-red-700 transition">-1 Team
        A</button>
    <button onclick="increaseScore('B')"
        class="py-2 px-6 bg-green-600 text-white rounded-lg mr-4 shadow-md hover:bg-green-700 transition">+1 Team
        B</button>
    <button onclick="decreaseScore('B')"
        class="py-2 px-6 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition">-1 Team B</button>
</div>

<div class="text-center mt-8">
    <p>Set Number: <span id="setNumber" class="font-bold">1</span></p>
    <p>Points to Win: <span id="pointsToWin" class="font-bold">5</span></p>
</div>

<div id="winnerMessage" class="mt-8 text-2xl font-bold text-green-500"></div>

<script>
    let scoreA = {{ match_data.current_set.team1_score }};
    let scoreB = {{ match_data.current_set.team2_score }};
    let  teamA_id = {{ match_data.team1_id }};
    let teamB_id = {{ match_data.team2_id }};
    let setNumber = {{ match_data.current_set.set_no }};
    let pointsToWin = {{ match_data.win_points }};
    let matchStarted = false;
    let setsWonA = {{ team_wins.team1 }};
    let setsWonB = {{ team_wins.team2 }};
    const maxSets = {{ match_data.no_sets }};

    const scoreADisplay = document.getElementById('scoreA');
    const scoreBDisplay = document.getElementById('scoreB');
    const setNumberDisplay = document.getElementById('setNumber');
    const pointsToWinDisplay = document.getElementById('pointsToWin');
    const winnerMessage = document.getElementById('winnerMessage');

    // Start the match and enable score buttons
    document.getElementById('startMatch').addEventListener('click', () => {
        matchStarted = true;
        alert('Match Started! Now you can update the scores.');
    });

    // Switch team cards with animation
    document.getElementById('switchTeams').addEventListener('click', () => {
        const teamA = document.querySelector('#teamA');
        const teamB = document.querySelector('#teamB');
        teamA.classList.add('switch-left');
        teamB.classList.add('switch-right');

        setTimeout(() => {
            // Swap team names
            const teamAName = document.querySelector('#teamA .team-name').innerText;
            const teamBName = document.querySelector('#teamB .team-name').innerText;

            document.querySelector('#teamA .team-name').innerText = teamBName;
            document.querySelector('#teamB .team-name').innerText = teamAName;

            // Reset animations
            teamA.classList.remove('switch-left');
            teamB.classList.remove('switch-right');
            teamA.classList.add('fade-in');
            teamB.classList.add('fade-in');

            setTimeout(() => {
                teamA.classList.remove('fade-in');
                teamB.classList.remove('fade-in');
            }, 500);
        }, 500);
    });

    // Increase score
    function increaseScore(team) {
        if (!matchStarted) {
            alert('Please start the match first!');
            return;
        }
        if (team === 'A') {
            scoreA++;
            scoreADisplay.innerText = scoreA;
            console.log(teamA_id);
            increment_api(teamA_id);
            checkWinCondition();
        } else if (team === 'B') {
            scoreB++;
            scoreBDisplay.innerText = scoreB;
            console.log(teamB_id);
            increment_api(teamB_id);
            checkWinCondition();
        }
    }

    // Decrease score
    function decreaseScore(team) {
        if (!matchStarted) {
            alert('Please start the match first!');
            return;
        }
        if (team === 'A' && scoreA > 0) {
            scoreA--;
            scoreADisplay.innerText = scoreA;
        } else if (team === 'B' && scoreB > 0) {
            scoreB--;
            scoreBDisplay.innerText = scoreB;
        }
    }


    // Check if a team has won the set
    function checkWinCondition() {
        if (scoreA >= pointsToWin) {
            alert('Team A wins the set!');
            setsWonA++;
            resetSet();
        } else if (scoreB >= pointsToWin) {
            alert('Team B wins the set!');
            setsWonB++;
            resetSet();
        }
    }

    // Reset the set after a win
    function resetSet() {
        scoreA = 0;
        scoreB = 0;
        scoreADisplay.innerText = scoreA;
        scoreBDisplay.innerText = scoreB;
        setNumber++;
        setNumberDisplay.innerText = setNumber;

        // Check if either team has won the majority of sets
        if (setsWonA === Math.ceil(maxSets / 2)) {
            declareWinner('A');
        } else if (setsWonB === Math.ceil(maxSets / 2)) {
            declareWinner('B');
        } else if (setNumber > maxSets) {
            declareWinner();  // This will handle the case where all sets are played and it's a draw.
        }
    }

    // Declare the winner after a team wins the majority of sets
    function declareWinner(winningTeam = '') {
        matchStarted = false;
        if (winningTeam === 'A') {
            winnerMessage.innerText = 'Team A is the overall winner!';
        } else if (winningTeam === 'B') {
            winnerMessage.innerText = 'Team B is the overall winner!';
        } else {
            // If no team has won the majority and all sets are played
            if (setsWonA > setsWonB) {
                winnerMessage.innerText = 'Team A is the overall winner!';
            } else if (setsWonB > setsWonA) {
                winnerMessage.innerText = 'Team B is the overall winner!';
            } else {
                winnerMessage.innerText = 'It\'s a draw!';
            }
        }
    }


    function increment_api(team_id){
        fetch('{% url "api:score_match" match_data.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                "inc": true,
                "team_id": team_id
            })
        })
    }
</script>


{% endblock body %}